{% extends "header.html" %}

{% block body %}
<style>
div.dataTables_wrapper 
{
    width: 80%;
}
h1
{
  font-size:28px;
}

thead input {
    width: 100%;
    font-size:11px;
    text-indent: 3px;
    font-weight: 600;
    margin:2px;
}


</style>

<h1>{{ title }}</h1>
<table id="table" class="display compact" style="width:100%">

</table>

<!-- Modal -->
<div class="modal fade" id="warn_modal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Delete Confirmation</h4>
        </div>
        <div class="modal-body">
          <p></p>
        </div>
        <div class="modal-footer">
          <button type="button" id="btnDelete" class="btn btn-danger"> Delete</button>
          <button type="button" id="btnClose" class="btn" data-dismiss="modal"> Cancel</button>
        </div>

      </div>
      
    </div>
  </div>

<script>
var keys;
$( document ).ready( function( $ ) 
{
    var tableHeaders="";
    $.each({{ columns|tojson}}, function(i, val){
    tableHeaders += "<th>" + val.name + "</th>";
    });     
  
    $("#table").empty();
    $("#table").append('<thead><tr>' + tableHeaders + '</tr> <tr>' + tableHeaders +'</tr><thead>');

    $('#table thead tr:eq(1) th').each( function (i) {
        var title = $(this).text();
        if (i >= 1){
        $(this).html( '<input type="text" placeholder="Search '+title+'" />' );
 
        $( 'input', this ).on( 'keyup change', function () {
            if ( table.column(i).search() !== this.value ) {
                table
                    .column(i)
                    .search( this.value )
                    .draw();
            }
        });
        }
        else {
            $(this).html( '&nbsp;&nbsp;&nbsp;&nbsp;' );
        }
    });

        var table=$('#table').DataTable({
            "ajax": {
                "url": {{ data_link|tojson }},  
                "dataType": "json",
                "dataSrc": "data",
                "contentType":"application/json"
            },
            "orderCellsTop": true,
            "columns":{{ columns|tojson }},
            "scrollY": "65vh",
            "scrollX": true, 
            "scrollCollapse": true,
            "oLanguage": {"sSearch": "Search All"},
            "dom": '<f<Bt>i>',
            "paginate": false,
            "columnDefs": [{
                "targets":   0,
                "orderable": false,
                "checkboxes": {
                    "selectRow": true
                }
            }],
            "select": {
                "style": 'multi',
                "blurable": true
            },
            buttons: 
            {
                dom: {
                button: {
                    tag: 'button',
                    className: ''
                    }
                },
                "buttons": 
                [  
                    {
                        "text": 'Create New',
                        "className": 'btn btn-primary',
                        action: function ( e, dt, button, config ) 
                        {
                            window.location = {{ create_link|tojson }};
                        },    
                    },

                    {
                        "attr":  {
                            "title": 'Copy',
                            "id": 'tblDelete'
                        },
                        "text": 'Delete',
                        "type": 'submit',
                        "class": 'close',
                        "className": 'btn btn-secondary',

                        action: function () 
                        {
                            var selected_rows=table.rows('.selected').data();
                            var length = table.rows('.selected').count();
                            keys = []

                            if (length > 0)
                            {
                                for (var i = 0; i < length; i++ )
                                {
                                    keys.push(selected_rows[i].id);
                                }
                                var mymodal = $('#warn_modal');
                                mymodal.find('.modal-body').text('You have selected ' + length + ' fee structure(s) to delete.');
                                mymodal.modal('show'); 
                            }
                            else {
                                alert("No Rows Selected")
                            }
                        }
                    },
                    {
                        extend: "csv",
                        className: "btn btn-secondary",
                    },
                    {
                        extend: "excel",
                        className: "btn btn-secondary",
                    }
                ]
            }
        });
    // Handle form submission event 
    table.on("click", "th.select-checkbox", function() {
    if ($("th.select-checkbox").hasClass("selected")) {
        table.rows().deselect();
        $("th.select-checkbox").removeClass("selected");
    } else {
        table.rows().select();
        $("th.select-checkbox").addClass("selected");
    }
    }).on("select deselect", function() {
    ("Some selection or deselection going on")
    if (table.rows({
            table: true
        }).count() !== table.rows().count()) {
        $("th.select-checkbox").removeClass("selected");
    } else {
        $("th.select-checkbox").addClass("selected");

        if ($("#tblDelete").hasClass("btn btn-secondary") && table.rows('.selected').count() > 0 ) 
        {
            $("#tblDelete").removeClass("btn btn-secondary");
            $("#tblDelete").addClass("btn btn-danger");
        }

        else if ($("#tblDelete").hasClass("btn btn-danger") && table.rows('.selected').count() == 0 )  
        {
            $("#tblDelete").removeClass("btn btn-danger");
            $("#tblDelete").addClass("btn btn-secondary");
        }
    }
    })
});
$(document).on("click", "#btnDelete", function(event)
{
    var mymodal = $('#warn_modal');
    mymodal.modal('hide');

    $.ajax({
    data : JSON.stringify(keys, null, '\t'),
    type : 'POST',
    url : {{ page_link|tojson }},
    contentType: 'application/json;charset=UTF-8',
    success: function() 
    {
        $('#table').DataTable().ajax.reload();
    }
    })
    keys=[] 
});

</script>

{% endblock %}

