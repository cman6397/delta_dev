{% extends "header.html" %}

{% block body %}
<style>
  .table {
    white-space:nowrap;
  }
  caption { 
		font-weight: 500;
		text-align:center;
		caption-side: top;
		font-size:18px;
		color: black;
    margin-top:-20px;
	}
  .content_container {
    position:relative;
    margin:50px;
    margin-top:25px;
    padding-top:10px;
    min-width:1000px;
    max-width:1500px;
    padding-bottom:10px;

  }
  .add_button {
    float:right;
    margin-top:30px;
    right:10px;
  }
  .left {
      position:absolute;
      text-align:left;
      float:left;
      float:top;
   }  
   .hidden {
        display:none;
   }
   .content_container {
    margin-bottom:25px;
   }
   .search_account {
    width: 300px;
    text-align:left;
  }
  .form-control {
    border: 0;
    outline: 0;
    background: transparent;
    border-bottom: 1px solid black;
    border-radius:0px;
    padding:0px;
    width:250px;
    height:35px;
    text-align:left;
    position:absolute;
    margin-top:31px;
  }
.form-control:focus{
    border-color: black;
    -webkit-box-shadow: none;
    box-shadow: none;
}
.modal-body{
  text-align: left;
}
.hidden {
  display:none;
}
   h1 {
    font-size:18px;
    float:left;
    margin-top:10px;
   }
  td:nth-child(1),td:nth-child(2){
    display: none
  }
  th:nth-child(1),th:nth-child(2){
    display: none
  }
  </style>

  	<div class = "content_container shadow">
      <form action="" method="post" novalidate>
            {{ billing_form.hidden_tag() }}
            <h1> Billing Group</h1>
            {{ billing_form.name(size=32, class='form-control', placeholder='Enter Name') }}
      </form> 
      <div class = "add_button">
          <button type="button" id="add_account" class="btn btn-primary"> Add Account </button>
          <button type="button" id="save" class="btn btn-secondary"> Save </button>
          <a class="btn btn-secondary" href="{{ page_link }}"> Cancel</a> </p>
      </div>

        <table class="table" id="account_table">
        <caption> Billing Group Accounts </caption>
        <thead>
          <tr>
          {% for column in account_columns %}
            <th>
            {{ column }}
            </th>
          {% endfor %}
          <th>
            Actions
          </th>
          </tr>
        </thead>

        <tbody>
          {% for row in account_rows %}
            <tr>
            {% for x in range(0, account_columns|length) %}
              <td>
              {{ row[x] if row[x] is not none else ''}} 
              </td>
            {% endfor %}
            <td>
              <button type="button" id="edit" class="btn btn-outline-warning btn-sm"> Edit </button>
              <button type="button" id="remove" class="btn btn-outline-danger btn-sm"> Remove </button>
            </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>

    <div class="modal fade" id="account_modal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Billing Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Accounts</h4>
        </div>
        <div class="modal-body">
          <div class="center">
            <select 
                class="search_account" id="account_selection">
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" id="modalAdd" class="btn btn-primary" disabled> Add Account </button>
          <button type="button" id="modalCancel" class="btn" data-dismiss="modal"> Cancel</button>
        </div>
      </div>
      
    </div>
    </div>

    <div class="modal fade" id="edit_account_modal" role="dialog">
    <div class="modal-dialog">
    
      <!-- Billing Modal content-->
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Account Details</h4>
        </div>
        <form action="" method="post" novalidate>
        <div class="modal-body">
            {{ account_form.hidden_tag() }}
            <p>
            {{ account_form.fee_location.label }}<br>
            {{ account_form.fee_location(class='custom-select mr-sm-1', id='fee_location') }}
            </p>
            <p>
            {{ account_form.payment_source.label }}<br>
            {{ account_form.payment_source(class='custom-select mr-sm-1', id='payment_source') }}
            </p>
            <p>
            {{ account_form.account_id(class='hidden', id='account_id') }}
            </p>
        </div>
        <div class="modal-footer">
          {{ account_form.submit(class='btn btn-primary', id = 'edit_account_submit') }}</button>
          <button type="button" id="modalCancel" class="btn btn-secondary" data-dismiss="modal"> Cancel</button>
        </div>
        </form>
      </div>
      
    </div>
    </div>

  <Script>
    function disable_enable(button, modal_selector) {
        if (modal_selector.val() == null) {
            button.prop('disabled', true);;
        }
        else {
            button.prop('disabled', false);;
        }          
    }
    function reset(modal, modal_selector) {
        modal.modal('hide');
        modal_selector.val(null).change();
    }
    function get_ids(){
      var table=document.getElementById("account_table");
      var billing_accounts = [];

      for (var i=1; i < table.rows.length; i++)
      {
        current_account= table.rows[i].cells[0].innerHTML.trim();
        billing_accounts.push(current_account);
      }
      return billing_accounts
    }

    $('#account_selection').change(function(event) {
        var button = $('#modalAdd')
        var modal_selector=$('#account_selection');
        disable_enable(button,modal_selector);
    });

    $(document).on("click", "#modalAdd", function(event){
      var table=document.getElementById("account_table");
      var table_length = table.rows.length;
      var modal_selector=$('#account_selection')
      var account=modal_selector.select2('data')[0]
      var keys=cols
      var modal = $('#account_modal');
      var table_ids=get_ids()
      var row = "<tr>"

      //If added account is not already in table add account
      if(table_ids.indexOf(account["id"]) == -1 )
      {
        for (var i=0; i < keys.length; i++)
        {
          current_cell = account[keys[i]]
          if (current_cell == null){
            current_cell = ''
          }
          row = row + "<td>" + current_cell + "</td>" 
        }
        row = row + "<td> <button type='button' id='edit' class='btn btn-outline-warning btn-sm'> Edit </button> <button type='button' id='remove' class='btn btn-outline-danger btn-sm'> Remove </button></td> </tr>"
        $(account_table).find('tbody').append(row);
        reset(modal,modal_selector)
      }
      else {
        alert("Account already added.")
      }
    });

    $(document).on("click", "#modalCancel", function(event)
    {
      var modal = $('#account_modal');
      var modal_selector=$('#account_selection')

      reset(modal,modal_selector)
    });

    $(document).on("click", "#edit", function(event)
    {
      var modal = $('#edit_account_modal');
      var payment_source_form = document.getElementById("payment_source")
      var fee_location_form = document.getElementById("fee_location")
      var account_id_form = document.getElementById("account_id")

      var row = $(this).parents('tr')
      var fee_location_id = row.find("td")[1].innerHTML.trim() || 0
      var payment_source = row.find("td")[7].innerHTML.trim()
      var account_id = row.find("td")[0].innerHTML.trim()

      payment_source_form.value = payment_source
      fee_location_form.value = fee_location_id
      account_id_form.value = account_id

      modal.modal('show');
    });

    $(document).on("click", "#remove", function(event)
    {
      $(this).parents('tr').detach();
    });

    $(document).on("click", "#add_account", function(event)
    {
      var modal = $('#account_modal');
      modal.modal('show'); 
    });

    $(document).on("click", "#save", function(event)
    {
      var data= {};
      var table=document.getElementById("account_table");
      var detail_url="{{ url_for('billing_group') }}" + "{{billing_group.id}}"

      data['billing_accounts'] = get_ids()
      data=JSON.stringify(data)

      $.ajax({
        data : data,
        type : 'POST',
        url : detail_url,
        contentType: 'application/json;charset=UTF-8'
      })
      window.location.href = "{{ page_link }}";
    });

    var account_data = {{ accounts_json|tojson }}
    var cols= {{account_columns|tojson}}
    
    $(document).ready(function() {
    $(".search_account").select2({
        placeholder: "Select Account",
        allowClear: true,
        data: account_data
    });

    $(".search_account").val(null).change();

    });

    </Script>

  {% endblock %}